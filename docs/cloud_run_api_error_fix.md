# Cloud Run 環境での Notion API 502 エラー対策

## 問題の背景

Cloud Run 環境で Notion API にアクセスする際に「502 Bad Gateway」エラーが発生する問題がありました。特にレシピ URL 登録機能の使用時に、このエラーが頻繁に観察されていました。

## 実装した対策

以下の改善を実装して、一時的なサーバーエラーに対する耐性を高めました：

### 1. エクスポネンシャルバックオフとジッター

API リクエストのリトライロジックを改善し、エクスポネンシャルバックオフとジッターを導入しました。これによりサーバーへの負荷を分散し、より効率的にリトライを行います。

```python
base_wait = min(retry_delay * (2 ** (attempt - 1)), 20)  # 最大20秒
jitter = random.uniform(0.5, 1.5)  # 50%～150%のランダム係数
wait_time = base_wait * jitter
```

### 2. リトライ対象のエラーコードの拡充

従来は 502/503/504 エラーのみをリトライ対象としていましたが、以下のエラーコードを追加しました：

- 429: レート制限エラー
- 500: 内部サーバーエラー
- 520, 524: Cloudflare 特有のエラー

### 3. ネットワークタイムアウトの設定

クラウド環境での接続問題に対応するため、タイムアウト値を明示的に設定しました：

```python
timeout = (10, 30)  # 接続タイムアウト10秒、読み取りタイムアウト30秒
```

### 4. エラーハンドリングの強化

専用のエラーハンドラーモジュールを導入し、エラーの種類に応じた処理と、ユーザーフレンドリーなエラーメッセージを提供できるようにしました。

## リトライ戦略

1. 最大リトライ回数を 3 回から 5 回に増加
2. エクスポネンシャルバックオフとジッターの導入
3. 一時的なネットワークエラーやタイムアウトもリトライ対象に追加
4. より詳細なエラーログの記録

## 期待される効果

- 一時的なサーバーエラー発生時の成功率向上
- より効率的なリトライによるサーバー負荷の分散
- 詳細なエラーログによる問題診断の容易化
- ユーザーに対するより親切なエラーメッセージの提供

## 今後の改善点

- 長期的な API 安定性の監視
- リトライ成功率の統計収集
- 必要に応じたリトライ戦略のさらなる調整
